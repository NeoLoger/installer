#
# This is the config file where we define what will be executed in the installer script.
#
# installer will read variables and will execute them one by one.
#
. installer-contrib-tweaks-preinstall.conf

execute+=(include/installInProgressSSH)
execute+=(tweaks/ubuntu-ufw-enable)
execute+=(tweaks/ubuntu-ufw-allowhttp)
execute+=(tweaks/ubuntu-updateos)

. installer-contrib-tweaks-optimize.conf

execute+=(services/apache-latest-osrepo)
execute+=(include/installInProgressHttpd)

execute+=(services/php-7.3-offirepo)
execute+=(services/php-fpm-module)
execute+=(tweaks/php-fpm-autoconfig)
execute+=(tweaks/php-fpm-tweaks)

execute+=(services/certbot-latest-offirepo-apache)
execute+=(tweaks/enable-ssl)
execute+=(tweaks/apache-enable-ssl-letsencrypt)
execute+=(tweaks/apache-enable-phpfpm)

###############################################################################################################################
## CHANGE APACHE PRTS ##
echo "change Apache prots to 8080|8443" | log
sed -i 's/80/8080/g' /etc/apache2/ports.conf
sed -i 's/443/8443/g' /etc/apache2/ports.conf
sed -i 's/80/8080/g'  /etc/apache2/sites-available/000-default.conf
sed -i 's/443/8443/g'  /etc/apache2/sites-available/default-ssl.conf

##
execute+=(tweaks/apache-restart-service)

## NGINX INSTALLATION ###
# Add this at the begining of all scripts.
execute+=(services/nginx-latest-offirepo)
##

## ENGENTRON CONFIG ###
if [ -f "include/startup.sh" ]; then
    . include/startup.sh
elif [ -f "../include/startup.sh" ]; then
    . ../include/startup.sh
fi

echo "pull engentron configs from github" | log
mv /etc/nginx/nginx.conf /etc/nginx/nginx.conf.orig
wget https://raw.githubusercontent.com/engintron/engintron/master/nginx/nginx.conf -O /etc/nginx/nginx.conf
wget https://raw.githubusercontent.com/engintron/engintron/master/nginx/common_http.conf -O /etc/nginx/common_http.conf
wget https://raw.githubusercontent.com/engintron/engintron/master/nginx/common_https.conf -O /etc/nginx/common_https.conf
wget https://raw.githubusercontent.com/engintron/engintron/master/nginx/custom_rules -O /etc/nginx/custom_rules
wget https://raw.githubusercontent.com/engintron/engintron/master/nginx/proxy_params_common -O /etc/nginx/proxy_params_common
wget https://raw.githubusercontent.com/engintron/engintron/master/nginx/proxy_params_dynamic -O /etc/nginx/proxy_params_dynamic
wget https://raw.githubusercontent.com/engintron/engintron/master/nginx/proxy_params_static -O /etc/nginx/proxy_params_static

echo "configure cloud-xip.io domain in Nginx default.conf|default_https.conf" | log
wget -qO- ifconfig.co > /serverIP.txt
sed -i 's/\./\-/g' /serverIP.txt  #replace all dots with lines

touch /etc/nginx/conf.d/default.conf
touch /etc/nginx/conf.d/default_https.conf

echo "
# /**
#  * @version    1.13.0
#  * @package    Engintron for cPanel/WHM
#  * @author     Fotis Evangelou (https://kodeka.io)
#  * @url        https://engintron.com
#  * @copyright  Copyright (c) 2018 - 2019 Kodeka OÜ. All rights reserved.
#  * @license    GNU/GPL license: https://www.gnu.org/copyleft/gpl.html
#  */

server {
    #listen 80 default_server;
    listen [::]:80 default_server ipv6only=off;

    server_name exampleip.cloud-xip.io www.exampleip.cloud-xip.io;
    return  301 https://\$server_name\$request_uri;
    # deny all; # DO NOT REMOVE OR CHANGE THIS LINE - Used when Engintron is disabled to block Nginx from becoming an open proxy

    # Set the port for HTTP proxying
    set \$PROXY_TO_PORT 8080;

    include common_http.conf;
}
" > /etc/nginx/conf.d/default.conf

#####################################
echo "
# /**
#  * @version    1.13.0
#  * @package    Engintron for cPanel/WHM
#  * @author     Fotis Evangelou (https://kodeka.io)
#  * @url        https://engintron.com
#  * @copyright  Copyright (c) 2018 - 2019 Kodeka OÜ. All rights reserved.
#  * @license    GNU/GPL license: https://www.gnu.org/copyleft/gpl.html
#  */

# Default definition block for HTTPS
server {

    listen 443 ssl http2 default_server;
    #listen [::]:443 ssl http2 default_server;
    server_name exampleip.cloud-xip.io www.exampleip.cloud-xip.io;

    ssl_certificate      /etc/ssl/certs/exampleip.cloud-xip.io.crt;
    ssl_certificate_key  /etc/ssl/private/exampleip.cloud-xip.io.key;

    include common_https.conf;
}

##### Additional Domains #####
#server {
#
#    listen 443 ssl http2;
#    server_name example.com www.example.com;
#
#    ssl_certificate      /etc/ssl/certs/exampleip.cloud-xip.io.crt;
#    ssl_certificate_key  /etc/ssl/private/exampleip.cloud-xip.io.key;
#
#    include common_https.conf;
#}
" > /etc/nginx/conf.d/default_https.conf

sed -i "s/exampleip/$(cat /serverIP.txt)/" /etc/nginx/conf.d/default.conf
sed -i "s/exampleip/$(cat /serverIP.txt)/" /etc/nginx/conf.d/default_https.conf

if [ ! -d /etc/ssl/engintron ]; then
    mkdir -p /etc/ssl/engintron
fi

openssl dhparam -out /etc/ssl/certs/dhparam.pem 2048

mkdir -p /var/cache/nginx
service nginx restart

###############################################################################################################################
execute+=(services/sendmail-latest-osrepo)

execute+=(tweaks/motd-header-tweak)
execute+=(tweaks/motd-description-append)
#execute+=(tweaks/cwm-description-autoconfig)

execute+=(include/installInProgressHttpd-remove)
execute+=(include/installInProgressSSH-remove)
